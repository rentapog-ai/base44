name: Auto PR Description

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  generate-description:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude to Generate PR Description
        id: claude-description
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Analyze this pull request and generate a complete PR description.

            IMPORTANT INSTRUCTIONS:
            1. Analyze all the changes in this PR to understand what it does
            2. Generate a PR description using the template format below
            3. Fill in ALL sections appropriately based on your analysis
            4. For checkbox items, mark with [x] if applicable or [ ] if not
            5. Update the PR description using: gh pr edit ${{ github.event.pull_request.number }} --body "..."

            USE THIS EXACT TEMPLATE FORMAT (fill in the placeholders and check appropriate boxes):

            > [!NOTE]
            > ## Description
            >
            > [2-4 sentence summary of what this PR does and why]
            >
            > ## Related Issue
            >
            > [Link any related issues, e.g., "Fixes #123" or "Closes #456", or "None" if not applicable]
            >
            > ## Type of Change
            >
            > - [ ] Bug fix (non-breaking change which fixes an issue)
            > - [ ] New feature (non-breaking change which adds functionality)
            > - [ ] Breaking change (fix or feature that would cause existing functionality to not work as expected)
            > - [ ] Documentation update
            > - [ ] Refactoring (no functional changes)
            > - [ ] Other (please describe):
            >
            > ## Changes Made
            >
            > [List the main changes as bullet points]
            >
            > ## Testing
            >
            > - [ ] I have tested these changes locally
            > - [ ] I have added/updated tests as needed
            > - [ ] All tests pass (`npm test`)
            >
            > ## Checklist
            >
            > - [ ] My code follows the project's style guidelines
            > - [ ] I have performed a self-review of my own code
            > - [ ] I have commented my code, particularly in hard-to-understand areas
            > - [ ] I have made corresponding changes to the documentation (if applicable)
            > - [ ] My changes generate no new warnings
            > - [ ] I have updated AGENTS.md if I made architectural changes
            >
            > ## Additional Notes
            >
            > [Any additional context, or "None"]
            >
            > ---
            > <sub>ðŸ¤– Generated by Claude | <relative-time datetime="[current UTC timestamp in ISO 8601 format: YYYY-MM-DDTHH:MM:SSZ]"></relative-time></sub>

            GUIDELINES FOR FILLING THE TEMPLATE:
            - Check [x] the appropriate "Type of Change" based on what the code does
            - For Testing checkboxes: check them ONLY if you can verify tests exist/pass from the PR
            - For Checklist items: check them based on your code analysis (e.g., check "style guidelines" if code follows existing patterns)
            - Be concise but informative in the Description and Changes Made sections
          claude_args: '--allowed-tools "Bash(gh pr:*)" "Bash(git diff:*)" "Bash(git log:*)" Read Glob Grep'
          allowed_bots: 'claude[bot]'
